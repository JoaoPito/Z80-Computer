CPM22.asm114MEM EQU 62 16IOBYTE EQU 3 17TDRIVE EQU 4 18ENTRY EQU 5 19TFCB EQU 5CH 20TBUFF EQU 80H 21TBASE EQU 100H 25CNTRLC EQU 3 26CNTRLE EQU 05H 27BS EQU 08H 28TAB EQU 09H 29LF EQU 0AH 30FF EQU 0CH 31CR EQU 0DH 32CNTRLP EQU 10H 33CNTRLR EQU 12H 34CNTRLS EQU 13H 35CNTRLU EQU 15H 36CNTRLX EQU 18H 37CNTRLZ EQU 1AH 38DEL EQU 7FH 42 ORG (MEM-7)*10244344CBASE: JP COMMAND 45 JP CLEARBUF 4751INBUFF: DEFB 127 52 DEFB 0 53 DEFB 'Copyright'54 DEFB ' 1979 (c) by Digital Research      '55 DEFB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,056 DEFB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,057 DEFB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,058 DEFB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,059INPOINT:DEFW INBUFF+2 60NAMEPNT:DEFW 0 65PRINT: LD E,A 66 LD C,267 JP ENTRY6871PRINTB: PUSH BC72 CALL PRINT73 POP BC74 RET 7579CRLF: LD A,CR80 CALL PRINTB81 LD A,LF82 JP PRINTB8386SPACE: LD A,' '87 JP PRINTB8892PLINE: PUSH BC93 CALL CRLF94 POP HL95PLINE2: LD A,(HL)96 OR A97 RET Z98 INC HL99 PUSH HL100 CALL PRINT101 POP HL102 JP PLINE2103106RESDSK: LD C,13107 JP ENTRY108111DSKSEL: LD E,A112 LD C,14113 JP ENTRY114118ENTRY1: CALL ENTRY119 LD (RTNCODE),A 120 INC A 121 RET 122125OPEN: LD C,15126 JP ENTRY1127130OPENFCB:XOR A 131 LD (FCB+32),A132 LD DE,FCB133 JP OPEN134137CLOSE: LD C,16138 JP ENTRY1139143SRCHFST:LD C,17144 JP ENTRY1145148SRCHNXT:LD C,18149 JP ENTRY1150153SRCHFCB:LD DE,FCB154 JP SRCHFST155158DELETE: LD C,19159 JP ENTRY160164ENTRY2: CALL ENTRY165 OR A 166 RET 167171RDREC: LD C,20172 JP ENTRY2173176READFCB:LD DE,FCB177 JP RDREC178182WRTREC: LD C,21183 JP ENTRY2184187CREATE: LD C,22188 JP ENTRY1189193RENAM: LD C,23194 JP ENTRY195198GETUSR: LD E,0FFH199203GETSETUC: LD C,32204 JP ENTRY205208SETCDRV:CALL GETUSR 209 ADD A,A 210 ADD A,A211 ADD A,A212 ADD A,A213 LD HL,CDRIVE 214 OR (HL)215 LD (TDRIVE),A 216 RET 217220MOVECD: LD A,(CDRIVE)221 LD (TDRIVE),A222 RET 223227UPPER: CP 'a' 228 RET C229 CP '{'230 RET NC231 AND 5FH 232 RET 233238GETINP: LD A,(BATCH) 239 OR A240 JP Z,GETINP1241246 LD A,(CDRIVE) 247 OR A248 LD A,0 249 CALL NZ,DSKSEL 250 LD DE,BATCHFCB251 CALL OPEN 252 JP Z,GETINP1 253 LD A,(BATCHFCB+15) 254 DEC A255 LD (BATCHFCB+32),A256 LD DE,BATCHFCB257 CALL RDREC 258 JP NZ,GETINP1 262 LD DE,INBUFF+1263 LD HL,TBUFF 264 LD B,128 265 CALL HL2DE 266 LD HL,BATCHFCB+14267 LD (HL),0 268 INC HL 269 DEC (HL)270 LD DE,BATCHFCB 271 CALL CLOSE272 JP Z,GETINP1 273 LD A,(CDRIVE) 274 OR A275 CALL NZ,DSKSEL 279 LD HL,INBUFF+2280 CALL PLINE2281 CALL CHKCON 282 JP Z,GETINP2 288 CALL DELBATCH 289 JP CMMND1 294GETINP1:CALL DELBATCH 295 CALL SETCDRV 296 LD C,10 297 LD DE,INBUFF298 CALL ENTRY299 CALL MOVECD 303GETINP2:LD HL,INBUFF+1304 LD B,(HL) 305GETINP3:INC HL306 LD A,B 307 OR A308 JP Z,GETINP4309 LD A,(HL) 310 CALL UPPER311 LD (HL),A312 DEC B 313 JP GETINP3314GETINP4:LD (HL),A 315 LD HL,INBUFF+2316 LD (INPOINT),HL 317 RET 318322CHKCON: LD C,11 323 CALL ENTRY324 OR A325 RET Z 326 LD C,1 327 CALL ENTRY328 OR A 329 RET 330333GETDSK: LD C,25334 JP ENTRY335338STDDMA: LD DE,TBUFF339342DMASET: LD C,26343 JP ENTRY344347DELBATCH: LD HL,BATCH 348 LD A,(HL)349 OR A350 RET Z351 LD (HL),0 352 XOR A353 CALL DSKSEL 354 LD DE,BATCHFCB 355 CALL DELETE356 LD A,(CDRIVE) 357 JP DSKSEL358362VERIFY: LD DE,PATTRN1 363 LD HL,PATTRN2 364 LD B,6 365VERIFY1:LD A,(DE)366 CP (HL)367 JP NZ,HALT 368 INC DE369 INC HL370 DEC B371 JP NZ,VERIFY1372 RET 373376SYNERR: CALL CRLF 377 LD HL,(NAMEPNT) 378SYNERR1:LD A,(HL) 379 CP ' '380 JP Z,SYNERR2381 OR A382 JP Z,SYNERR2383 PUSH HL384 CALL PRINT385 POP HL386 INC HL387 JP SYNERR1388SYNERR2:LD A,'?' 389 CALL PRINT390 CALL CRLF391 CALL DELBATCH 392 JP CMMND1 397CHECK: LD A,(DE)398 OR A399 RET Z400 CP ' ' 401 JP C,SYNERR402 RET Z 403 CP '='404 RET Z405 CP '_'406 RET Z407 CP '.'408 RET Z409 CP ':'410 RET Z411 CP ';'412 RET Z413 CP '<'414 RET Z415 CP '>'416 RET Z417 RET 418421NONBLANK: LD A,(DE)422 OR A 423 RET Z424 CP ' '425 RET NZ426 INC DE427 JP NONBLANK428431ADDHL: ADD A,L432 LD L,A433 RET NC 434 INC H435 RET 436439CONVFST:LD A,0440445CONVERT:LD HL,FCB446 CALL ADDHL447 PUSH HL448 PUSH HL449 XOR A450 LD (CHGDRV),A 451 LD HL,(INPOINT) 452 EX DE,HL453 CALL NONBLANK 454 EX DE,HL455 LD (NAMEPNT),HL 456 EX DE,HL457 POP HL458 LD A,(DE) 459 OR A460 JP Z,CONVRT1461 SBC A,'A'-1 462 LD B,A 463 INC DE 464 LD A,(DE)465 CP ':'466 JP Z,CONVRT2467 DEC DE 468CONVRT1:LD A,(CDRIVE)469 LD (HL),A470 JP CONVRT3471CONVRT2:LD A,B472 LD (CHGDRV),A 473 LD (HL),B474 INC DE475478CONVRT3:LD B,08H479CONVRT4:CALL CHECK480 JP Z,CONVRT8481 INC HL482 CP '*' 483 JP NZ,CONVRT5 484 LD (HL),'?'485 JP CONVRT6486CONVRT5:LD (HL),A487 INC DE488CONVRT6:DEC B489 JP NZ,CONVRT4490CONVRT7:CALL CHECK 491 JP Z,GETEXT492 INC DE493 JP CONVRT7494CONVRT8:INC HL 495 LD (HL),' '496 DEC B497 JP NZ,CONVRT8498501GETEXT: LD B,03H502 CP '.'503 JP NZ,GETEXT5504 INC DE505GETEXT1:CALL CHECK506 JP Z,GETEXT5507 INC HL508 CP '*'509 JP NZ,GETEXT2510 LD (HL),'?'511 JP GETEXT3512GETEXT2:LD (HL),A513 INC DE514GETEXT3:DEC B515 JP NZ,GETEXT1516GETEXT4:CALL CHECK517 JP Z,GETEXT6518 INC DE519 JP GETEXT4520GETEXT5:INC HL521 LD (HL),' '522 DEC B523 JP NZ,GETEXT5524GETEXT6:LD B,3525GETEXT7:INC HL526 LD (HL),0527 DEC B528 JP NZ,GETEXT7529 EX DE,HL530 LD (INPOINT),HL 531 POP HL532536 LD BC,11 537GETEXT8:INC HL538 LD A,(HL)539 CP '?' 540 JP NZ,GETEXT9541 INC B 542GETEXT9:DEC C543 JP NZ,GETEXT8544 LD A,B545 OR A546 RET 547550NUMCMDS EQU 6 551CMDTBL: DEFB 'DIR '552 DEFB 'ERA '553 DEFB 'TYPE'554 DEFB 'SAVE'555 DEFB 'REN '556 DEFB 'USER'557561PATTRN1:DEFB 0,22,0,0,0,0 569SEARCH: LD HL,CMDTBL570 LD C,0571SEARCH1:LD A,C572 CP NUMCMDS 573 RET NC574 LD DE,FCB+1 575 LD B,4 576SEARCH2:LD A,(DE)577 CP (HL)578 JP NZ,SEARCH3 579 INC DE580 INC HL581 DEC B582 JP NZ,SEARCH2583 LD A,(DE) 584 CP ' '585 JP NZ,SEARCH4586 LD A,C 587 RET 588SEARCH3:INC HL589 DEC B590 JP NZ,SEARCH3591SEARCH4:INC C592 JP SEARCH1593597CLEARBUF: XOR A598 LD (INBUFF+1),A 607COMMAND:LD SP,CCPSTACK 608 PUSH BC 609 LD A,C 610 RRA 611 RRA 612 RRA 613 RRA 614 AND 0FH 615 LD E,A616 CALL GETSETUC 617 CALL RESDSK 618 LD (BATCH),A 619 POP BC620 LD A,C621 AND 0FH 622 LD (CDRIVE),A 623 CALL DSKSEL 624 LD A,(INBUFF+1)625 OR A 626 JP NZ,CMMND2 630CMMND1: LD SP,CCPSTACK 631 CALL CRLF 632 CALL GETDSK 633 ADD A,'a'634 CALL PRINT 635 LD A,'>'636 CALL PRINT 637 CALL GETINP 641CMMND2: LD DE,TBUFF642 CALL DMASET 643 CALL GETDSK644 LD (CDRIVE),A 645 CALL CONVFST 646 CALL NZ,SYNERR 647 LD A,(CHGDRV) 648 OR A 649 JP NZ,UNKNOWN 650 CALL SEARCH 656 LD HL,CMDADR 657 LD E,A 658 LD D,0659 ADD HL,DE660 ADD HL,DE 661 LD A,(HL) 662 INC HL663 LD H,(HL)664 LD L,A665 JP (HL) 669CMDADR: DEFW DIRECT,ERASE,TYPE,SAVE670 DEFW RENAME,USER,UNKNOWN671674HALT: LD HL,76F3H 675 LD (CBASE),HL676 LD HL,CBASE677 JP (HL)678681RDERROR:LD BC,RDERR682 JP PLINE683RDERR: DEFB 'Read error',0684687NONE: LD BC,NOFILE688 JP PLINE689NOFILE: DEFB 'No file',0690696DECODE: CALL CONVFST 697 LD A,(CHGDRV) 698 OR A699 JP NZ,SYNERR700 LD HL,FCB+1 701 LD BC,11 702DECODE1:LD A,(HL)703 CP ' ' 704 JP Z,DECODE3705 INC HL706 SUB '0' 707 CP 10 708 JP NC,SYNERR709 LD D,A 710 LD A,B 711 AND 0E0H712 JP NZ,SYNERR713 LD A,B714 RLCA 715 RLCA 716 RLCA 717 ADD A,B 718 JP C,SYNERR719 ADD A,B 720 JP C,SYNERR721 ADD A,D 722DECODE2:JP C,SYNERR723 LD B,A 724 DEC C 725 JP NZ,DECODE1726 RET 727DECODE3:LD A,(HL) 728 CP ' '729 JP NZ,SYNERR730 INC HL731DECODE4:DEC C732 JP NZ,DECODE3733 LD A,B 734 RET 735739MOVE3: LD B,3740743HL2DE: LD A,(HL)744 LD (DE),A745 INC HL746 INC DE747 DEC B748 JP NZ,HL2DE749 RET 750753EXTRACT:LD HL,TBUFF754 ADD A,C755 CALL ADDHL756 LD A,(HL)757 RET 758763DSELECT:XOR A 764 LD (FCB),A765 LD A,(CHGDRV) 766 OR A767 RET Z768 DEC A 769 LD HL,CDRIVE770 CP (HL)771 RET Z772 JP DSKSEL 777RESETDR:LD A,(CHGDRV) 778 OR A779 RET Z780 DEC A 781 LD HL,CDRIVE782 CP (HL)783 RET Z784 LD A,(CDRIVE) 785 JP DSKSEL786793DIRECT: CALL CONVFST 794 CALL DSELECT 795 LD HL,FCB+1 796 LD A,(HL)797 CP ' '798 JP NZ,DIRECT2799 LD B,11 800DIRECT1:LD (HL),'?'801 INC HL802 DEC B803 JP NZ,DIRECT1804DIRECT2:LD E,0 805 PUSH DE806 CALL SRCHFCB 807 CALL Z,NONE 808DIRECT3:JP Z,DIRECT9 809 LD A,(RTNCODE) 810 RRCA 811 RRCA 812 RRCA 813 AND 60H 814 LD C,A815 LD A,10816 CALL EXTRACT 817 RLA 818 JP C,DIRECT8 819 POP DE820 LD A,E 821 INC E822 PUSH DE823 AND 03H 824 PUSH AF825 JP NZ,DIRECT4826 CALL CRLF 827 PUSH BC828 CALL GETDSK 829 POP BC830 ADD A,'A'831 CALL PRINTB832 LD A,':'833 CALL PRINTB834 JP DIRECT5835DIRECT4:CALL SPACE 836 LD A,':'837 CALL PRINTB838DIRECT5:CALL SPACE839 LD B,1 840DIRECT6:LD A,B841 CALL EXTRACT842 AND 7FH 843 CP ' ' 844 JP NZ,DRECT65845 POP AF 846 PUSH AF847 CP 3848 JP NZ,DRECT63849 LD A,9 850 CALL EXTRACT851 AND 7FH852 CP ' '853 JP Z,DIRECT7 854DRECT63:LD A,' ' 855DRECT65:CALL PRINTB856 INC B 857 LD A,B858 CP 12 859 JP NC,DIRECT7860 CP 9 861 JP NZ,DIRECT6862 CALL SPACE 863 JP DIRECT6864DIRECT7:POP AF 865DIRECT8:CALL CHKCON 866 JP NZ,DIRECT9867 CALL SRCHNXT 868 JP DIRECT3 869DIRECT9:POP DE 870 JP GETBACK871878ERASE: CALL CONVFST 879 CP 11 880 JP NZ,ERASE1881 LD BC,YESNO 882 CALL PLINE883 CALL GETINP884 LD HL,INBUFF+1885 DEC (HL) 886 JP NZ,CMMND1887 INC HL888 LD A,(HL)889 CP 'Y'890 JP NZ,CMMND1891 INC HL892 LD (INPOINT),HL 893ERASE1: CALL DSELECT 894 LD DE,FCB895 CALL DELETE 896 INC A897 CALL Z,NONE 898 JP GETBACK 899YESNO: DEFB 'All (y/n)?',0900907TYPE: CALL CONVFST 908 JP NZ,SYNERR 909 CALL DSELECT 910 CALL OPENFCB 911 JP Z,TYPE5 912 CALL CRLF 913 LD HL,NBYTES 914 LD (HL),0FFH 915TYPE1: LD HL,NBYTES916TYPE2: LD A,(HL) 917 CP 128918 JP C,TYPE3919 PUSH HL 920 CALL READFCB921 POP HL922 JP NZ,TYPE4 923 XOR A 924 LD (HL),A925TYPE3: INC (HL) 926 LD HL,TBUFF 927 CALL ADDHL928 LD A,(HL)929 CP CNTRLZ 930 JP Z,GETBACK931 CALL PRINT 932 CALL CHKCON 933 JP NZ,GETBACK934 JP TYPE1935938TYPE4: DEC A 939 JP Z,GETBACK940 CALL RDERROR 941TYPE5: CALL RESETDR 942 JP SYNERR 950SAVE: CALL DECODE 951 PUSH AF 952 CALL CONVFST 953 JP NZ,SYNERR 954 CALL DSELECT 955 LD DE,FCB 956 PUSH DE957 CALL DELETE958 POP DE959 CALL CREATE 960 JP Z,SAVE3 961 XOR A 962 LD (FCB+32),A963 POP AF 964 LD L,A965 LD H,0966 ADD HL,HL 967 LD DE,TBASE 968SAVE1: LD A,H 969 OR L970 JP Z,SAVE2971 DEC HL 972 PUSH HL 973 LD HL,128974 ADD HL,DE975 PUSH HL 976 CALL DMASET977 LD DE,FCB 978 CALL WRTREC979 POP DE 980 POP HL 981 JP NZ,SAVE3 982 JP SAVE1983986SAVE2: LD DE,FCB 987 CALL CLOSE988 INC A 989 JP NZ,SAVE4990993SAVE3: LD BC,NOSPACE994 CALL PLINE995SAVE4: CALL STDDMA 996 JP GETBACK997NOSPACE:DEFB 'No space',09981005RENAME: CALL CONVFST 1006 JP NZ,SYNERR 1007 LD A,(CHGDRV) 1008 PUSH AF1009 CALL DSELECT 1010 CALL SRCHFCB 1011 JP NZ,RENAME6 1012 LD HL,FCB 1013 LD DE,FCB+161014 LD B,161015 CALL HL2DE1016 LD HL,(INPOINT) 1017 EX DE,HL1018 CALL NONBLANK 1019 CP '=' 1020 JP Z,RENAME11021 CP '_'1022 JP NZ,RENAME51023RENAME1:EX DE,HL1024 INC HL 1025 LD (INPOINT),HL 1026 CALL CONVFST 1027 JP NZ,RENAME5 1028 POP AF 1029 LD B,A 1030 LD HL,CHGDRV1031 LD A,(HL)1032 OR A1033 JP Z,RENAME21034 CP B1035 LD (HL),B1036 JP NZ,RENAME5 1037RENAME2:LD (HL),B 1038 XOR A1039 LD (FCB),A 1040RENAME3:CALL SRCHFCB 1041 JP Z,RENAME4 1042 LD DE,FCB1043 CALL RENAM 1044 JP GETBACK10451048RENAME4:CALL NONE 1049 JP GETBACK1050RENAME5:CALL RESETDR 1051 JP SYNERR1052RENAME6:LD BC,EXISTS 1053 CALL PLINE1054 JP GETBACK1055EXISTS: DEFB 'File exists',010561063USER: CALL DECODE 1064 CP 16 1065 JP NC,SYNERR1066 LD E,A 1067 LD A,(FCB+1)1068 CP ' '1069 JP Z,SYNERR 1070 CALL GETSETUC 1071 JP GETBACK110721079UNKNOWN:CALL VERIFY 1080 LD A,(FCB+1) 1081 CP ' '1082 JP NZ,UNKWN11083 LD A,(CHGDRV) 1084 OR A1085 JP Z,GETBACK1 1086 DEC A1087 LD (CDRIVE),A 1088 CALL MOVECD 1089 CALL DSKSEL 1090 JP GETBACK1 1094UNKWN1: LD DE,FCB+9 1095 LD A,(DE)1096 CP ' '1097 JP NZ,SYNERR 1098UNKWN2: PUSH DE1099 CALL DSELECT 1100 POP DE1101 LD HL,COMFILE 1102 CALL MOVE31103 CALL OPENFCB 1104 JP Z,UNKWN9 1108 LD HL,TBASE 1109UNKWN3: PUSH HL1110 EX DE,HL1111 CALL DMASET 1112 LD DE,FCB 1113 CALL RDREC1114 JP NZ,UNKWN4 1115 POP HL 1116 LD DE,1281117 ADD HL,DE1118 LD DE,CBASE 1119 LD A,L1120 SUB E1121 LD A,H1122 SBC A,D1123 JP NC,UNKWN0 1124 JP UNKWN311251128UNKWN4: POP HL1129 DEC A 1130 JP NZ,UNKWN01131 CALL RESETDR 1132 CALL CONVFST 1133 LD HL,CHGDRV 1134 PUSH HL1135 LD A,(HL) 1136 LD (FCB),A1137 LD A,16 1138 CALL CONVERT 1139 POP HL1140 LD A,(HL) 1141 LD (FCB+16),A1142 XOR A 1143 LD (FCB+32),A1144 LD DE,TFCB 1145 LD HL,FCB1146 LD B,331147 CALL HL2DE1148 LD HL,INBUFF+2 1149UNKWN5: LD A,(HL) 1150 OR A 1151 JP Z,UNKWN61152 CP ' '1153 JP Z,UNKWN61154 INC HL1155 JP UNKWN511561159UNKWN6: LD B,0 1160 LD DE,TBUFF+1 1161UNKWN7: LD A,(HL) 1162 LD (DE),A1163 OR A1164 JP Z,UNKWN81165 INC B1166 INC HL1167 INC DE1168 JP UNKWN71169UNKWN8: LD A,B 1170 LD (TBUFF),A1171 CALL CRLF 1172 CALL STDDMA 1173 CALL SETCDRV 1174 CALL TBASE 1178 LD SP,BATCH 1179 CALL MOVECD 1180 CALL DSKSEL 1181 JP CMMND1 1185UNKWN9: CALL RESETDR 1186 JP SYNERR1187UNKWN0: LD BC,BADLOAD 1188 CALL PLINE1189 JP GETBACK1190BADLOAD:DEFB 'Bad load',01191COMFILE:DEFB 'COM' 1197GETBACK:CALL RESETDR 1198GETBACK1: CALL CONVFST 1199 LD A,(FCB+1) 1200 SUB ' ' 1201 LD HL,CHGDRV1202 OR (HL)1203 JP NZ,SYNERR1204 JP CMMND1 1208 DEFB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,01209CCPSTACK EQU $ 1213BATCH: DEFB 0 1214BATCHFCB: DEFB 0,'$$$     SUB',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,012151218FCB: DEFB 0,'           ',0,0,0,0,0,'           ',0,0,0,0,01219RTNCODE:DEFB 0 1220CDRIVE: DEFB 0 1221CHGDRV: DEFB 0 1222NBYTES: DEFW 0 1226 DEFB 0,0,0,0,0,0,0,0,0,0,0,0,012271231PATTRN2:DEFB 0,22,0,0,0,0 1239FBASE: JP FBASE112401243BADSCTR:DEFW ERROR1 1244BADSLCT:DEFW ERROR2 1245RODISK: DEFW ERROR3 1246ROFILE: DEFW ERROR4 1251FBASE1: EX DE,HL 1252 LD (PARAMS),HL1253 EX DE,HL1254 LD A,E 1255 LD (EPARAM),A1256 LD HL,01257 LD (STATUS),HL 1258 ADD HL,SP1259 LD (USRSTACK),HL 1260 LD SP,STKAREA 1261 XOR A 1262 LD (AUTOFLAG),A1263 LD (AUTO),A1264 LD HL,GOBACK 1265 PUSH HL1266 LD A,C 1267 CP NFUNCTS 1268 RET NC1269 LD C,E 1270 LD HL,FUNCTNS 1271 LD E,A1272 LD D,0 1273 ADD HL,DE1274 ADD HL,DE 1275 LD E,(HL)1276 INC HL1277 LD D,(HL) 1278 LD HL,(PARAMS) 1279 EX DE,HL 1280 JP (HL) 1284NFUNCTS EQU 41 1286FUNCTNS:DEFW WBOOT,GETCON,OUTCON,GETRDR,PUNCH,LIST,DIRCIO,GETIOB1287 DEFW SETIOB,PRTSTR,RDBUFF,GETCSTS,GETVER,RSTDSK,SETDSK,OPENFIL1288 DEFW CLOSEFIL,GETFST,GETNXT,DELFILE,READSEQ,WRTSEQ,FCREATE1289 DEFW RENFILE,GETLOG,GETCRNT,PUTDMA,GETALOC,WRTPRTD,GETROV,SETATTR1290 DEFW GETPARM,GETUSER,RDRANDOM,WTRANDOM,FILESIZE,SETRAN,LOGOFF,RTN1291 DEFW RTN,WTSPECL12921295ERROR1: LD HL,BADSEC 1296 CALL PRTERR 1297 CP CNTRLC 1298 JP Z,0 1299 RET 1301ERROR2: LD HL,BADSEL 1302 JP ERROR513031304ERROR3: LD HL,DISKRO 1305 JP ERROR513061307ERROR4: LD HL,FILERO 1309ERROR5: CALL PRTERR1310 JP 0 1312BDOSERR:DEFB 'Bdos Err On '1313BDOSDRV:DEFB ' : $'1314BADSEC: DEFB 'Bad Sector$'1315BADSEL: DEFB 'Select$'1316FILERO: DEFB 'File '1317DISKRO: DEFB 'R/O$'13181321PRTERR: PUSH HL 1322 CALL OUTCRLF 1323 LD A,(ACTIVE) 1324 ADD A,'A' 1325 LD (BDOSDRV),A 1326 LD BC,BDOSERR 1327 CALL PRTMESG1328 POP BC 1329 CALL PRTMESG13301334GETCHAR:LD HL,CHARBUF 1335 LD A,(HL) 1336 LD (HL),0 1337 OR A1338 RET NZ 1339 JP CONIN 1343GETECHO:CALL GETCHAR 1344 CALL CHKCHAR 1345 RET C 1346 PUSH AF 1347 LD C,A1348 CALL OUTCON 1349 POP AF 1350 RET 13511356CHKCHAR:CP CR 1357 RET Z 1358 CP LF1359 RET Z1360 CP TAB1361 RET Z1362 CP BS1363 RET Z1364 CP ' ' 1365 RET 13661372CKCONSOL: LD A,(CHARBUF) 1373 OR A 1374 JP NZ,CKCON21375 CALL CONST 1376 AND 01H 1377 RET Z 1378 CALL CONIN 1379 CP CNTRLS 1380 JP NZ,CKCON11381 CALL CONIN 1382 CP CNTRLC 1383 JP Z,0 1384 XOR A 1385 RET 1386CKCON1: LD (CHARBUF),A 1387CKCON2: LD A,1 1388 RET 13891394OUTCHAR:LD A,(OUTFLAG) 1395 OR A 1396 JP NZ,OUTCHR11397 PUSH BC1398 CALL CKCONSOL 1399 POP BC1400 PUSH BC1401 CALL CONOUT 1402 POP BC1403 PUSH BC1404 LD A,(PRTFLAG) 1405 OR A1406 CALL NZ,LIST 1407 POP BC1408OUTCHR1:LD A,C 1409 LD HL,CURPOS1410 CP DEL 1411 RET Z1412 INC (HL) 1413 CP ' ' 1414 RET NC1415 DEC (HL) 1416 LD A,(HL)1417 OR A1418 RET Z 1419 LD A,C1420 CP BS 1421 JP NZ,OUTCHR21422 DEC (HL) 1423 RET 1424OUTCHR2:CP LF 1425 RET NZ 1426 LD (HL),0 1427 RET 14281432SHOWIT: LD A,C1433 CALL CHKCHAR 1434 JP NC,OUTCON 1435 PUSH AF1436 LD C,'^' 1437 CALL OUTCHAR1438 POP AF1439 OR '@' 1440 LD C,A14411445OUTCON: LD A,C1446 CP TAB 1447 JP NZ,OUTCHAR 1448OUTCON1:LD C,' ' 1449 CALL OUTCHAR1450 LD A,(CURPOS) 1452 AND 07H 1453 JP NZ,OUTCON11454 RET 14551459BACKUP: CALL BACKUP1 1460 LD C,' ' 1461 CALL CONOUT1462BACKUP1:LD C,BS 1463 JP CONOUT14641468NEWLINE:LD C,'#'1469 CALL OUTCHAR 1470 CALL OUTCRLF 1471NEWLN1: LD A,(CURPOS) 1472 LD HL,STARTING1473 CP (HL)1474 RET NC 1475 LD C,' '1476 CALL OUTCHAR 1477 JP NEWLN114781481OUTCRLF:LD C,CR1482 CALL OUTCHAR1483 LD C,LF1484 JP OUTCHAR14851488PRTMESG:LD A,(BC) 1489 CP '$'1490 RET Z1491 INC BC1492 PUSH BC 1493 LD C,A1494 CALL OUTCON1495 POP BC1496 JP PRTMESG14971500RDBUFF: LD A,(CURPOS) 1501 LD (STARTING),A1502 LD HL,(PARAMS) 1503 LD C,(HL)1504 INC HL 1505 PUSH HL 1506 LD B,0 1507RDBUF1: PUSH BC1508 PUSH HL1509RDBUF2: CALL GETCHAR 1510 AND 7FH 1511 POP HL 1512 POP BC1513 CP CR 1514 JP Z,RDBUF171515 CP LF1516 JP Z,RDBUF171517 CP BS 1518 JP NZ,RDBUF31519 LD A,B 1520 OR A1521 JP Z,RDBUF11522 DEC B 1523 LD A,(CURPOS) 1524 LD (OUTFLAG),A 1525 JP RDBUF101526RDBUF3: CP DEL 1527 JP NZ,RDBUF41528 LD A,B 1529 OR A1530 JP Z,RDBUF11531 LD A,(HL) 1532 DEC B 1533 DEC HL1534 JP RDBUF151535RDBUF4: CP CNTRLE 1536 JP NZ,RDBUF51537 PUSH BC 1538 PUSH HL1539 CALL OUTCRLF1540 XOR A 1541 LD (STARTING),A1542 JP RDBUF21543RDBUF5: CP CNTRLP 1544 JP NZ,RDBUF61545 PUSH HL 1546 LD HL,PRTFLAG1547 LD A,1 1548 SUB (HL)1549 LD (HL),A1550 POP HL1551 JP RDBUF11552RDBUF6: CP CNTRLX 1553 JP NZ,RDBUF81554 POP HL1555RDBUF7: LD A,(STARTING) 1556 LD HL,CURPOS1557 CP (HL)1558 JP NC,RDBUFF 1559 DEC (HL) 1560 CALL BACKUP1561 JP RDBUF71562RDBUF8: CP CNTRLU 1563 JP NZ,RDBUF91564 CALL NEWLINE 1565 POP HL1566 JP RDBUFF1567RDBUF9: CP CNTRLR 1568 JP NZ,RDBUF141569RDBUF10:PUSH BC 1570 CALL NEWLINE1571 POP BC1572 POP HL1573 PUSH HL1574 PUSH BC1575RDBUF11:LD A,B 1576 OR A1577 JP Z,RDBUF121578 INC HL 1579 LD C,(HL)1580 DEC B 1581 PUSH BC1582 PUSH HL1583 CALL SHOWIT 1584 POP HL1585 POP BC1586 JP RDBUF111587RDBUF12:PUSH HL 1588 LD A,(OUTFLAG) 1589 OR A1590 JP Z,RDBUF21591 LD HL,CURPOS 1592 SUB (HL) 1593 LD (OUTFLAG),A 1594RDBUF13:CALL BACKUP 1595 LD HL,OUTFLAG 1596 DEC (HL)1597 JP NZ,RDBUF131598 JP RDBUF2 1602RDBUF14:INC HL1603 LD (HL),A 1604 INC B 1605RDBUF15:PUSH BC1606 PUSH HL1607 LD C,A 1608 CALL SHOWIT1609 POP HL1610 POP BC1611 LD A,(HL) 1612 CP CNTRLC 1613 LD A,B1614 JP NZ,RDBUF161615 CP 1 1616 JP Z,01617RDBUF16:CP C 1618 JP C,RDBUF11619RDBUF17:POP HL 1620 LD (HL),B1621 LD C,CR1622 JP OUTCHAR 1626GETCON: CALL GETECHO 1627 JP SETSTAT 1631GETRDR: CALL READER 1632 JP SETSTAT16331638DIRCIO: LD A,C 1639 INC A1640 JP Z,DIRC11641 INC A 1642 JP Z,CONST1643 JP CONOUT 1644DIRC1: CALL CONST 1645 OR A1646 JP Z,GOBACK1 1647 CALL CONIN 1648 JP SETSTAT 1652GETIOB: LD A,(IOBYTE)1653 JP SETSTAT16541657SETIOB: LD HL,IOBYTE1658 LD (HL),C1659 RET 16601664PRTSTR: EX DE,HL1665 LD C,L1666 LD B,H 1667 JP PRTMESG16681671GETCSTS:CALL CKCONSOL16721676SETSTAT:LD (STATUS),A1677RTN: RET 16781681IOERR1: LD A,11682 JP SETSTAT16831684OUTFLAG:DEFB 0 1685STARTING: DEFB 2 1686CURPOS: DEFB 0 1687PRTFLAG:DEFB 0 1688CHARBUF:DEFB 0 1692USRSTACK: DEFW 0 1694 DEFB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,01695 DEFB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,01696STKAREA EQU $ 1698USERNO: DEFB 0 1699ACTIVE: DEFB 0 1700PARAMS: DEFW 0 1701STATUS: DEFW 0 1705SLCTERR:LD HL,BADSLCT17061709JUMPHL: LD E,(HL)1710 INC HL1711 LD D,(HL) 1712 EX DE,HL1713 JP (HL)17141717DE2HL: INC C 1718DE2HL1: DEC C1719 RET Z 1720 LD A,(DE) 1721 LD (HL),A1722 INC DE1723 INC HL1724 JP DE2HL1 1728SELECT: LD A,(ACTIVE) 1729 LD C,A1730 CALL SELDSK 1731 LD A,H 1732 OR L 1733 RET Z 1738 LD E,(HL) 1739 INC HL1740 LD D,(HL)1741 INC HL1742 LD (SCRATCH1),HL 1743 INC HL1744 INC HL1745 LD (SCRATCH2),HL 1746 INC HL1747 INC HL1748 LD (SCRATCH3),HL 1749 INC HL1750 INC HL1751 EX DE,HL 1752 LD (XLATE),HL1753 LD HL,DIRBUF 1754 LD C,8 1755 CALL DE2HL 1756 LD HL,(DISKPB) 1757 EX DE,HL1758 LD HL,SECTORS 1759 LD C,15 1760 CALL DE2HL1761 LD HL,(DSKSIZE) 1762 LD A,H 1763 LD HL,BIGDISK1764 LD (HL),0FFH 1765 OR A1766 JP Z,SELECT11767 LD (HL),0 1768SELECT1:LD A,0FFH 1769 OR A1770 RET 17711774HOMEDRV:CALL HOME 1775 XOR A1776 LD HL,(SCRATCH2) 1777 LD (HL),A1778 INC HL1779 LD (HL),A1780 LD HL,(SCRATCH3) 1781 LD (HL),A1782 INC HL1783 LD (HL),A1784 RET 17851788DOREAD: CALL READ1789 JP IORET17901793DOWRITE:CALL WRITE1794IORET: OR A1795 RET Z 1796 LD HL,BADSCTR 1797 JP JUMPHL17981802TRKSEC: LD HL,(FILEPOS) 1803 LD C,2 1804 CALL SHIFTR 1805 LD (BLKNMBR),HL 1806 LD (CKSUMTBL),HL 1811TRKSEC1:LD HL,BLKNMBR1812 LD C,(HL) 1813 INC HL1814 LD B,(HL)1815 LD HL,(SCRATCH3) 1816 LD E,(HL) 1817 INC HL1818 LD D,(HL)1819 LD HL,(SCRATCH2) 1820 LD A,(HL) 1821 INC HL1822 LD H,(HL)1823 LD L,A1824TRKSEC2:LD A,C 1825 SUB E1826 LD A,B1827 SBC A,D1828 JP NC,TRKSEC31829 PUSH HL 1830 LD HL,(SECTORS) 1831 LD A,E1832 SUB L1833 LD E,A1834 LD A,D1835 SBC A,H1836 LD D,A 1837 POP HL1838 DEC HL 1839 JP TRKSEC21840TRKSEC3:PUSH HL 1841 LD HL,(SECTORS) 1842 ADD HL,DE 1843 JP C,TRKSEC41844 LD A,C 1845 SUB L1846 LD A,B1847 SBC A,H1848 JP C,TRKSEC41849 EX DE,HL 1850 POP HL 1851 INC HL1852 JP TRKSEC318531857TRKSEC4:POP HL 1858 PUSH BC1859 PUSH DE1860 PUSH HL1861 EX DE,HL1862 LD HL,(OFFSET) 1863 ADD HL,DE1864 LD B,H1865 LD C,L1866 CALL SETTRK 1867 POP DE 1868 LD HL,(SCRATCH2)1869 LD (HL),E1870 INC HL1871 LD (HL),D1872 POP DE1873 LD HL,(SCRATCH3) 1874 LD (HL),E1875 INC HL1876 LD (HL),D1877 POP BC1878 LD A,C 1879 SUB E 1880 LD C,A1881 LD A,B1882 SBC A,D1883 LD B,A1884 LD HL,(XLATE) 1885 EX DE,HL1886 CALL SECTRN 1887 LD C,L1888 LD B,H1889 JP SETSEC 1894GETBLOCK: LD HL,BLKSHFT 1895 LD C,(HL) 1896 LD A,(SAVNREC) 1897GETBLK1:OR A 1898 RRA 1899 DEC C1900 JP NZ,GETBLK11901 LD B,A 1902 LD A,81903 SUB (HL)1904 LD C,A 1905 LD A,(SAVEXT)1906GETBLK2:DEC C 1907 JP Z,GETBLK31908 OR A1909 RLA 1910 JP GETBLK21911GETBLK3:ADD A,B1912 RET 19131919EXTBLK: LD HL,(PARAMS) 1920 LD DE,16 1921 ADD HL,DE1922 ADD HL,BC1923 LD A,(BIGDISK) 1924 OR A1925 JP Z,EXTBLK11926 LD L,(HL) 1927 LD H,01928 RET 1929EXTBLK1:ADD HL,BC 1930 LD E,(HL)1931 INC HL1932 LD D,(HL)1933 EX DE,HL 1934 RET 19351938COMBLK: CALL GETBLOCK1939 LD C,A1940 LD B,01941 CALL EXTBLK1942 LD (BLKNMBR),HL1943 RET 19441947CHKBLK: LD HL,(BLKNMBR)1948 LD A,L 1949 OR H1950 RET 19511958LOGICAL:LD A,(BLKSHFT) 1959 LD HL,(BLKNMBR) 1960LOGICL1:ADD HL,HL 1961 DEC A 1962 JP NZ,LOGICL11963 LD (LOGSECT),HL 1964 LD A,(BLKMASK) 1965 LD C,A1966 LD A,(SAVNREC) 1967 AND C 1968 OR L 1969 LD L,A1970 LD (BLKNMBR),HL 1971 RET 19721975SETEXT: LD HL,(PARAMS)1976 LD DE,12 1977 ADD HL,DE1978 RET 19791983SETHLDE:LD HL,(PARAMS)1984 LD DE,15 1985 ADD HL,DE1986 EX DE,HL1987 LD HL,17 1988 ADD HL,DE1989 RET 19901993STRDATA:CALL SETHLDE1994 LD A,(HL) 1995 LD (SAVNREC),A1996 EX DE,HL1997 LD A,(HL) 1998 LD (SAVNXT),A1999 CALL SETEXT 2000 LD A,(EXTMASK) 2001 AND (HL)2002 LD (SAVEXT),A 2003 RET 20042009SETNREC:CALL SETHLDE2010 LD A,(MODE) 2011 CP 2 2012 JP NZ,STNREC12013 XOR A 2014STNREC1:LD C,A2015 LD A,(SAVNREC) 2016 ADD A,C 2017 LD (HL),A 2018 EX DE,HL2019 LD A,(SAVNXT) 2020 LD (HL),A 2021 RET 20222025SHIFTR: INC C2026SHIFTR1:DEC C2027 RET Z2028 LD A,H2029 OR A2030 RRA 2031 LD H,A2032 LD A,L2033 RRA 2034 LD L,A2035 JP SHIFTR120362040CHECKSUM: LD C,128 2041 LD HL,(DIRBUF) 2042 XOR A 2043CHKSUM1:ADD A,M 2044 INC HL2045 DEC C2046 JP NZ,CHKSUM12047 RET 20482051SHIFTL: INC C2052SHIFTL1:DEC C2053 RET Z2054 ADD HL,HL 2055 JP SHIFTL120562060SETBIT: PUSH BC 2061 LD A,(ACTIVE) 2062 LD C,A2063 LD HL,12064 CALL SHIFTL 2065 POP BC 2066 LD A,C2067 OR L2068 LD L,A 2069 LD A,B2070 OR H2071 LD H,A2072 RET 20732077GETWPRT:LD HL,(WRTPRT) 2078 LD A,(ACTIVE) 2079 LD C,A2080 CALL SHIFTR 2081 LD A,L 2082 AND 01H 2083 RET 20842087WRTPRTD:LD HL,WRTPRT 2088 LD C,(HL) 2089 INC HL2090 LD B,(HL)2091 CALL SETBIT 2092 LD (WRTPRT),HL 2093 LD HL,(DIRSIZE) 2094 INC HL 2095 EX DE,HL2096 LD HL,(SCRATCH1) 2097 LD (HL),E 2098 INC HL2099 LD (HL),D 2100 RET 21012104CHKROFL:CALL FCB2HL 2105CKROF1: LD DE,9 2106 ADD HL,DE2107 LD A,(HL)2108 RLA 2109 RET NC 2110 LD HL,ROFILE 2111 JP JUMPHL21122115CHKWPRT:CALL GETWPRT2116 RET Z 2117 LD HL,RODISK 2118 JP JUMPHL21192123FCB2HL: LD HL,(DIRBUF) 2124 LD A,(FCBPOS) 2128ADDA2HL:ADD A,L2129 LD L,A2130 RET NC2131 INC H 2132 RET 21332137GETS2: LD HL,(PARAMS) 2138 LD DE,14 2139 ADD HL,DE2140 LD A,(HL) 2141 RET 21422145CLEARS2:CALL GETS2 2146 LD (HL),0 2147 RET 21482151SETS2B7:CALL GETS2 2152 OR 80H 2153 LD (HL),A 2154 RET 21552161MOREFLS:LD HL,(FILEPOS) 2162 EX DE,HL2163 LD HL,(SCRATCH1) 2164 LD A,E 2165 SUB (HL)2166 INC HL2167 LD A,D2168 SBC A,M 2169 RET 21702174CHKNMBR:CALL MOREFLS 2175 RET C2176 INC DE 2177 LD (HL),D2178 DEC HL2179 LD (HL),E2180 RET 21812184SUBHL: LD A,E 2185 SUB L2186 LD L,A 2187 LD A,D2188 SBC A,H2189 LD H,A 2190 RET 21912194SETDIR: LD C,0FFH21952201CHECKDIR: LD HL,(CKSUMTBL)2202 EX DE,HL2203 LD HL,(ALLOC1)2204 CALL SUBHL2205 RET NC 2206 PUSH BC2207 CALL CHECKSUM 2208 LD HL,(CHKVECT) 2209 EX DE,HL2210 LD HL,(CKSUMTBL)2211 ADD HL,DE 2212 POP BC2213 INC C 2214 JP Z,CHKDIR12215 CP (HL) 2216 RET Z 2217 CALL MOREFLS 2218 RET NC2219 CALL WRTPRTD 2220 RET 2221CHKDIR1:LD (HL),A 2222 RET 22232226DIRWRITE: CALL SETDIR 2227 CALL DIRDMA 2228 LD C,1 2229 CALL DOWRITE 2230 JP DEFDMA22312234DIRREAD:CALL DIRDMA 2235 CALL DOREAD 2239DEFDMA: LD HL,USERDMA 2240 JP DIRDMA122412244DIRDMA: LD HL,DIRBUF22452249DIRDMA1:LD C,(HL)2250 INC HL2251 LD B,(HL) 2252 JP SETDMA22532256MOVEDIR:LD HL,(DIRBUF) 2257 EX DE,HL2258 LD HL,(USERDMA) 2259 LD C,128 2260 JP DE2HL 2264CKFILPOS: LD HL,FILEPOS2265 LD A,(HL)2266 INC HL2267 CP (HL) 2268 RET NZ2269 INC A 2270 RET 22712274STFILPOS: LD HL,0FFFFH2275 LD (FILEPOS),HL2276 RET 22772286NXENTRY:LD HL,(DIRSIZE) 2287 EX DE,HL2288 LD HL,(FILEPOS) 2289 INC HL 2290 LD (FILEPOS),HL2291 CALL SUBHL 2292 JP NC,NXENT1 2293 JP STFILPOS 2294NXENT1: LD A,(FILEPOS) 2295 AND 03H 2296 LD B,5 2297NXENT2: ADD A,A 2298 DEC B 2299 JP NZ,NXENT22300 LD (FCBPOS),A 2301 OR A2302 RET NZ 2303 PUSH BC2304 CALL TRKSEC 2305 CALL DIRREAD2306 POP BC2307 JP CHECKDIR23082315CKBITMAP: LD A,C 2316 AND 07H 2317 INC A2318 LD E,A 2319 LD D,A23202323 LD A,C2324 RRCA 2325 RRCA 2326 RRCA 2327 AND 1FH 2328 LD C,A2329 LD A,B2330 ADD A,A 2331 ADD A,A2332 ADD A,A2333 ADD A,A2334 ADD A,A2335 OR C 2336 LD C,A 2337 LD A,B 2338 RRCA 2339 RRCA 2340 RRCA 2341 AND 1FH2342 LD B,A 2347 LD HL,(ALOCVECT)2348 ADD HL,BC2349 LD A,(HL) 2350CKBMAP1:RLCA 2351 DEC E2352 JP NZ,CKBMAP12353 RET 23542359STBITMAP: PUSH DE2360 CALL CKBITMAP 2361 AND 0FEH 2362 POP BC2363 OR C 2370STBMAP1:RRCA 2371 DEC D2372 JP NZ,STBMAP12373 LD (HL),A 2374 RET 23752379SETFILE:CALL FCB2HL 2380 LD DE,162381 ADD HL,DE 2382 PUSH BC2383 LD C,17 2384SETFL1: POP DE2385 DEC C 2386 RET Z2387 PUSH DE2388 LD A,(BIGDISK) 2389 OR A2390 JP Z,SETFL22391 PUSH BC 2392 PUSH HL2393 LD C,(HL) 2394 LD B,0 2395 JP SETFL32396SETFL2: DEC C 2397 PUSH BC2398 LD C,(HL) 2399 INC HL2400 LD B,(HL)2401 PUSH HL2402SETFL3: LD A,C 2403 OR B2404 JP Z,SETFL42405 LD HL,(DSKSIZE) 2406 LD A,L 2407 SUB C2408 LD A,H2409 SBC A,B2410 CALL NC,STBITMAP 2411SETFL4: POP HL 2412 INC HL2413 POP BC2414 JP SETFL124152421BITMAP: LD HL,(DSKSIZE) 2422 LD C,32423 CALL SHIFTR 2424 INC HL 2425 LD B,H2426 LD C,L 2435 LD HL,(ALOCVECT) 2436BITMAP1:LD (HL),02437 INC HL2438 DEC BC2439 LD A,B2440 OR C2441 JP NZ,BITMAP12442 LD HL,(ALLOC0) 2443 EX DE,HL2444 LD HL,(ALOCVECT) 2445 LD (HL),E2446 INC HL2447 LD (HL),D24482451 CALL HOMEDRV 2452 LD HL,(SCRATCH1)2453 LD (HL),3 2454 INC HL 2455 LD (HL),02456 CALL STFILPOS 2457BITMAP2:LD C,0FFH 2458 CALL NXENTRY 2459 CALL CKFILPOS 2460 RET Z2461 CALL FCB2HL 2462 LD A,0E5H2463 CP (HL) 2464 JP Z,BITMAP22465 LD A,(USERNO) 2466 CP (HL)2467 JP NZ,BITMAP32468 INC HL2469 LD A,(HL) 2470 SUB '$'2471 JP NZ,BITMAP32472 DEC A 2473 LD (STATUS),A2474BITMAP3:LD C,1 2475 CALL SETFILE2476 CALL CHKNMBR 2477 JP BITMAP224782481STSTATUS: LD A,(FNDSTAT)2482 JP SETSTAT24832489SAMEXT: PUSH BC2490 PUSH AF2491 LD A,(EXTMASK) 2492 CPL 2493 LD B,A 2494 LD A,C 2495 AND B2496 LD C,A2497 POP AF 2498 AND B 2499 SUB C2500 AND 1FH 2501 POP BC 2502 RET 2508FINDFST:LD A,0FFH2509 LD (FNDSTAT),A2510 LD HL,COUNTER 2511 LD (HL),C2512 LD HL,(PARAMS) 2513 LD (SAVEFCB),HL 2514 CALL STFILPOS 2515 CALL HOMEDRV 2521FINDNXT:LD C,0 2522 CALL NXENTRY 2523 CALL CKFILPOS 2524 JP Z,FNDNXT6 2525 LD HL,(SAVEFCB) 2526 EX DE,HL2527 LD A,(DE)2528 CP 0E5H 2529 JP Z,FNDNXT1 2530 PUSH DE2531 CALL MOREFLS 2532 POP DE2533 JP NC,FNDNXT6 2534FNDNXT1:CALL FCB2HL 2535 LD A,(COUNTER) 2536 LD C,A2537 LD B,0 2538FNDNXT2:LD A,C 2539 OR A2540 JP Z,FNDNXT52541 LD A,(DE) 2542 CP '?' 2543 JP Z,FNDNXT42544 LD A,B 2545 CP 13 2546 JP Z,FNDNXT42547 CP 12 2548 LD A,(DE)2549 JP Z,FNDNXT32550 SUB (HL) 2551 AND 7FH2552 JP NZ,FINDNXT 2553 JP FNDNXT4 2554FNDNXT3:PUSH BC 2555 LD C,(HL)2556 CALL SAMEXT2557 POP BC2558 JP NZ,FINDNXT 2563FNDNXT4:INC DE 2564 INC HL2565 INC B2566 DEC C 2567 JP FNDNXT22568FNDNXT5:LD A,(FILEPOS) 2569 AND 03H2570 LD (STATUS),A2571 LD HL,FNDSTAT2572 LD A,(HL)2573 RLA 2574 RET NC2575 XOR A2576 LD (HL),A2577 RET 25782581FNDNXT6:CALL STFILPOS 2582 LD A,0FFH 2583 JP SETSTAT25842588ERAFILE:CALL CHKWPRT 2589 LD C,12 2590 CALL FINDFST 2591ERAFIL1:CALL CKFILPOS 2592 RET Z 2593 CALL CHKROFL 2594 CALL FCB2HL 2595 LD (HL),0E5H 2596 LD C,0 2597 CALL SETFILE2598 CALL DIRWRITE 2599 CALL FINDNXT 2600 JP ERAFIL1 2615FNDSPACE: LD D,B 2616 LD E,C26172621FNDSPA1:LD A,C 2622 OR B2623 JP Z,FNDSPA22624 DEC BC 2625 PUSH DE2626 PUSH BC2627 CALL CKBITMAP2628 RRA 2629 JP NC,FNDSPA3 2639 POP BC 2640 POP DE26412644FNDSPA2:LD HL,(DSKSIZE) 2645 LD A,E2646 SUB L2647 LD A,D2648 SBC A,H2649 JP NC,FNDSPA42650 INC DE 2651 PUSH BC2652 PUSH DE2653 LD B,D2654 LD C,E2655 CALL CKBITMAP 2656 RRA 2657 JP NC,FNDSPA32658 POP DE 2659 POP BC2660 JP FNDSPA126612665FNDSPA3:RLA 2666 INC A 2667 CALL STBMAP1 2668 POP HL 2669 POP DE2670 RET 26712675FNDSPA4:LD A,C2676 OR B2677 JP NZ,FNDSPA12678 LD HL,0 2679 RET 26802683FCBSET: LD C,02684 LD E,32 2690UPDATE: PUSH DE2691 LD B,0 2692 LD HL,(PARAMS) 2693 ADD HL,BC 2694 EX DE,HL2695 CALL FCB2HL 2696 POP BC 2697 CALL DE2HL2698UPDATE1:CALL TRKSEC 2699 JP DIRWRITE 2705CHGNAMES: CALL CHKWPRT 2706 LD C,12 2707 CALL FINDFST 2708 LD HL,(PARAMS) 2709 LD A,(HL) 2710 LD DE,16 2711 ADD HL,DE2712 LD (HL),A 2713CHGNAM1:CALL CKFILPOS 2714 RET Z 2715 CALL CHKROFL 2716 LD C,16 2717 LD E,12 2718 CALL UPDATE2719 CALL FINDNXT 2720 JP CHGNAM1 2727SAVEATTR: LD C,12 2728 CALL FINDFST 2729SAVATR1:CALL CKFILPOS 2730 RET Z 2731 LD C,0 2732 LD E,122733 CALL UPDATE 2734 CALL FINDNXT 2735 JP SAVATR1 2739OPENIT: LD C,15 2740 CALL FINDFST 2741 CALL CKFILPOS 2742 RET Z2743OPENIT1:CALL SETEXT 2744 LD A,(HL) 2745 PUSH AF 2746 PUSH HL2747 CALL FCB2HL 2748 EX DE,HL2749 LD HL,(PARAMS) 2750 LD C,32 2751 PUSH DE2752 CALL DE2HL2753 CALL SETS2B7 2754 POP DE 2755 LD HL,122756 ADD HL,DE2757 LD C,(HL) 2758 LD HL,15 2759 ADD HL,DE2760 LD B,(HL)2761 POP HL 2762 POP AF2763 LD (HL),A2764 LD A,C 2765 CP (HL)2766 LD A,B 2767 JP Z,OPENIT22768 LD A,0 2769 JP C,OPENIT2 2770 LD A,128 2771OPENIT2:LD HL,(PARAMS) 2772 LD DE,152773 ADD HL,DE 2774 LD (HL),A 2775 RET 27762782MOVEWORD: LD A,(HL) 2783 INC HL2784 OR (HL) 2785 DEC HL2786 RET NZ 2787 LD A,(DE) 2788 LD (HL),A 2789 INC DE2790 INC HL2791 LD A,(DE)2792 LD (HL),A2793 DEC DE 2794 DEC HL2795 RET 27962799CLOSEIT:XOR A 2800 LD (STATUS),A2801 LD (FILEPOS),A2802 LD (FILEPOS+1),A2803 CALL GETWPRT 2804 RET NZ 2805 CALL GETS2 2806 AND 80H 2807 RET NZ 2808 LD C,15 2809 CALL FINDFST2810 CALL CKFILPOS 2811 RET Z 2812 LD BC,16 2813 CALL FCB2HL2814 ADD HL,BC2815 EX DE,HL2816 LD HL,(PARAMS) 2817 ADD HL,BC2818 LD C,16 2819CLOSEIT1: LD A,(BIGDISK) 2820 OR A2821 JP Z,CLOSEIT42822 LD A,(HL) 2823 OR A2824 LD A,(DE) 2825 JP NZ,CLOSEIT22826 LD (HL),A 2827CLOSEIT2: OR A2828 JP NZ,CLOSEIT32829 LD A,(HL) 2830 LD (DE),A2831CLOSEIT3: CP (HL) 2832 JP NZ,CLOSEIT7 2833 JP CLOSEIT5 2834CLOSEIT4: CALL MOVEWORD 2835 EX DE,HL2836 CALL MOVEWORD 2837 EX DE,HL2838 LD A,(DE) 2839 CP (HL) 2840 JP NZ,CLOSEIT72841 INC DE 2842 INC HL2843 LD A,(DE)2844 CP (HL)2845 JP NZ,CLOSEIT72846 DEC C 2847CLOSEIT5: INC DE 2848 INC HL2849 DEC C 2850 JP NZ,CLOSEIT1 2851 LD BC,0FFECH 2852 ADD HL,BC2853 EX DE,HL2854 ADD HL,BC2855 LD A,(DE)2856 CP (HL) 2857 JP C,CLOSEIT6 2858 LD (HL),A 2859 LD BC,3 2860 ADD HL,BC 2861 EX DE,HL2862 ADD HL,BC2863 LD A,(HL) 2864 LD (DE),A 2865CLOSEIT6: LD A,0FFH 2866 LD (CLOSEFLG),A2867 JP UPDATE1 2868CLOSEIT7: LD HL,STATUS 2869 DEC (HL)2870 RET 28712875GETEMPTY: CALL CHKWPRT 2876 LD HL,(PARAMS) 2877 PUSH HL2878 LD HL,EMPTYFCB 2879 LD (PARAMS),HL2880 LD C,1 2881 CALL FINDFST 2882 CALL CKFILPOS 2883 POP HL2884 LD (PARAMS),HL 2885 RET Z 2886 EX DE,HL2887 LD HL,15 2888 ADD HL,DE2889 LD C,17 2890 XOR A2891GETMT1: LD (HL),A2892 INC HL2893 DEC C2894 JP NZ,GETMT12895 LD HL,13 2896 ADD HL,DE2897 LD (HL),A2898 CALL CHKNMBR 2899 CALL FCBSET 2900 JP SETS2B7 2905GETNEXT:XOR A2906 LD (CLOSEFLG),A 2907 CALL CLOSEIT 2908 CALL CKFILPOS2909 RET Z 2910 LD HL,(PARAMS) 2911 LD BC,122912 ADD HL,BC2913 LD A,(HL) 2914 INC A2915 AND 1FH 2916 LD (HL),A2917 JP Z,GTNEXT1 2918 LD B,A 2919 LD A,(EXTMASK)2920 AND B2921 LD HL,CLOSEFLG 2922 AND (HL)2923 JP Z,GTNEXT2 2924 JP GTNEXT3 2925GTNEXT1:LD BC,2 2926 ADD HL,BC2927 INC (HL) 2928 LD A,(HL) 2929 AND 0FH2930 JP Z,GTNEXT5 2934GTNEXT2:LD C,15 2935 CALL FINDFST 2936 CALL CKFILPOS 2937 JP NZ,GTNEXT32938 LD A,(RDWRTFLG) 2939 INC A 2940 JP Z,GTNEXT5 2941 CALL GETEMPTY 2942 CALL CKFILPOS 2943 JP Z,GTNEXT5 2944 JP GTNEXT4 2945GTNEXT3:CALL OPENIT1 2946GTNEXT4:CALL STRDATA 2947 XOR A 2948 JP SETSTAT29492953GTNEXT5:CALL IOERR1 2954 JP SETS2B7 2958RDSEQ: LD A,1 2959 LD (MODE),A2960RDSEQ1: LD A,0FFH 2961 LD (RDWRTFLG),A2962 CALL STRDATA 2963 LD A,(SAVNREC) 2964 LD HL,SAVNXT 2965 CP (HL) 2966 JP C,RDSEQ22967 CP 128 2968 JP NZ,RDSEQ3 2969 CALL GETNEXT 2970 XOR A 2971 LD (SAVNREC),A2972 LD A,(STATUS) 2973 OR A2974 JP NZ,RDSEQ3 2975RDSEQ2: CALL COMBLK 2976 CALL CHKBLK 2977 JP Z,RDSEQ3 2978 CALL LOGICAL 2979 CALL TRKSEC1 2980 CALL DOREAD 2981 JP SETNREC 2985RDSEQ3: JP IOERR129862989WTSEQ: LD A,1 2990 LD (MODE),A2991WTSEQ1: LD A,0 2992 LD (RDWRTFLG),A2993 CALL CHKWPRT 2994 LD HL,(PARAMS)2995 CALL CKROF1 2996 CALL STRDATA 2997 LD A,(SAVNREC) 2998 CP 128 2999 JP NC,IOERR1 3000 CALL COMBLK 3001 CALL CHKBLK 3002 LD C,0 3003 JP NZ,WTSEQ6 3004 CALL GETBLOCK 3005 LD (RELBLOCK),A 3006 LD BC,0 3007 OR A 3008 JP Z,WTSEQ23009 LD C,A 3010 DEC BC 3011 CALL EXTBLK3012 LD B,H3013 LD C,L3014WTSEQ2: CALL FNDSPACE 3015 LD A,L 3016 OR H3017 JP NZ,WTSEQ33018 LD A,2 3019 JP SETSTAT3020WTSEQ3: LD (BLKNMBR),HL 3021 EX DE,HL 3022 LD HL,(PARAMS) 3023 LD BC,16 3024 ADD HL,BC3025 LD A,(BIGDISK) 3026 OR A3027 LD A,(RELBLOCK) 3028 JP Z,WTSEQ4 3029 CALL ADDA2HL 3030 LD (HL),E 3031 JP WTSEQ53032WTSEQ4: LD C,A 3033 LD B,03034 ADD HL,BC3035 ADD HL,BC3036 LD (HL),E 3037 INC HL3038 LD (HL),D3039WTSEQ5: LD C,2 3040WTSEQ6: LD A,(STATUS) 3041 OR A3042 RET NZ3043 PUSH BC 3044 CALL LOGICAL 3045 LD A,(MODE) 3046 DEC A 3047 DEC A3048 JP NZ,WTSEQ930493054 POP BC3055 PUSH BC3056 LD A,C 3057 DEC A3058 DEC A3059 JP NZ,WTSEQ93060 PUSH HL3061 LD HL,(DIRBUF) 3062 LD D,A 3063WTSEQ7: LD (HL),A3064 INC HL3065 INC D 3066 JP P,WTSEQ73067 CALL DIRDMA 3068 LD HL,(LOGSECT) 3069 LD C,2 3070WTSEQ8: LD (BLKNMBR),HL 3071 PUSH BC3072 CALL TRKSEC1 3073 POP BC3074 CALL DOWRITE 3075 LD HL,(BLKNMBR) 3076 LD C,0 3077 LD A,(BLKMASK) 3078 LD B,A 3079 AND L3080 CP B3081 INC HL 3082 JP NZ,WTSEQ8 3083 POP HL 3084 LD (BLKNMBR),HL3085 CALL DEFDMA 3090WTSEQ9: CALL TRKSEC1 3091 POP BC 3092 PUSH BC3093 CALL DOWRITE 3094 POP BC3095 LD A,(SAVNREC) 3096 LD HL,SAVNXT 3097 CP (HL)3098 JP C,WTSEQ103099 LD (HL),A 3100 INC (HL)3101 LD C,231023106WTSEQ10:NOP 3107 NOP 3108 LD HL,0 3112 PUSH AF3113 CALL GETS2 3114 AND 7FH 3115 LD (HL),A3116 POP AF 3117WTSEQ99:CP 127 3118 JP NZ,WTSEQ123119 LD A,(MODE) 3120 CP 13121 JP NZ,WTSEQ123122 CALL SETNREC 3123 CALL GETNEXT 3124 LD HL,STATUS 3125 LD A,(HL)3126 OR A3127 JP NZ,WTSEQ113128 DEC A 3129 LD (SAVNREC),A3130WTSEQ11:LD (HL),0 3131WTSEQ12:JP SETNREC 3149POSITION: XOR A 3150 LD (MODE),A31513154POSITN1:PUSH BC 3155 LD HL,(PARAMS) 3156 EX DE,HL3157 LD HL,33 3158 ADD HL,DE3159 LD A,(HL)3160 AND 7FH 3161 PUSH AF3162 LD A,(HL) 3163 RLA 3164 INC HL3165 LD A,(HL)3166 RLA 3167 AND 1FH 3168 LD C,A 3169 LD A,(HL) 3170 RRA 3171 RRA 3172 RRA 3173 RRA 3174 AND 0FH3175 LD B,A 3176 POP AF 3177 INC HL 3178 LD L,(HL)3179 INC L3180 DEC L3181 LD L,6 3182 JP NZ,POSITN5 3183 LD HL,32 3184 ADD HL,DE3185 LD (HL),A3186 LD HL,12 3187 ADD HL,DE3188 LD A,C3189 SUB (HL) 3190 JP NZ,POSITN23191 LD HL,14 3192 ADD HL,DE3193 LD A,B3194 SUB (HL)3195 AND 7FH3196 JP Z,POSITN3 3200POSITN2:PUSH BC3201 PUSH DE3202 CALL CLOSEIT 3203 POP DE3204 POP BC3205 LD L,3 3206 LD A,(STATUS)3207 INC A3208 JP Z,POSITN4 3209 LD HL,12 3210 ADD HL,DE3211 LD (HL),C3212 LD HL,14 3213 ADD HL,DE3214 LD (HL),B3215 CALL OPENIT 3216 LD A,(STATUS) 3217 INC A3218 JP NZ,POSITN33219 POP BC 3220 PUSH BC3221 LD L,4 3222 INC C3223 JP Z,POSITN4 3224 CALL GETEMPTY 3225 LD L,5 3226 LD A,(STATUS)3227 INC A3228 JP Z,POSITN4 3232POSITN3:POP BC 3233 XOR A 3234 JP SETSTAT32353238POSITN4:PUSH HL3239 CALL GETS23240 LD (HL),0C0H3241 POP HL32423245POSITN5:POP BC3246 LD A,L 3247 LD (STATUS),A3248 JP SETS2B732493252READRAN:LD C,0FFH 3253 CALL POSITION 3254 CALL Z,RDSEQ1 3255 RET 32563259WRITERAN: LD C,0 3260 CALL POSITION 3261 CALL Z,WTSEQ1 3262 RET 32633272COMPRAND: EX DE,HL 3273 ADD HL,DE 3274 LD C,(HL) 3275 LD B,03276 LD HL,12 3277 ADD HL,DE3278 LD A,(HL) 3279 RRCA 3280 AND 80H 3281 ADD A,C 3282 LD C,A3283 LD A,0 3284 ADC A,B3285 LD B,A3286 LD A,(HL) 3287 RRCA 3288 AND 0FH 3289 ADD A,B 3290 LD B,A3291 LD HL,14 3292 ADD HL,DE3293 LD A,(HL)3294 ADD A,A 3295 ADD A,A3296 ADD A,A3297 ADD A,A3298 PUSH AF 3299 ADD A,B 3300 LD B,A3301 PUSH AF 3302 POP HL 3303 LD A,L3304 POP HL 3305 OR L 3306 AND 01H 3307 RET 33083317RANSIZE:LD C,12 3318 CALL FINDFST 3319 LD HL,(PARAMS) 3320 LD DE,333321 ADD HL,DE3322 PUSH HL3323 LD (HL),D 3324 INC HL3325 LD (HL),D3326 INC HL3327 LD (HL),D3328RANSIZ1:CALL CKFILPOS 3329 JP Z,RANSIZ3 3330 CALL FCB2HL 3331 LD DE,15 3332 CALL COMPRAND 3333 POP HL3334 PUSH HL 3335 LD E,A 3336 LD A,C 3337 SUB (HL) 3338 INC HL 3339 LD A,B3340 SBC A,M3341 INC HL3342 LD A,E3343 SBC A,M3344 JP C,RANSIZ23345 LD (HL),E 3346 DEC HL 3347 LD (HL),B3348 DEC HL3349 LD (HL),C3350RANSIZ2:CALL FINDNXT 3351 JP RANSIZ1 3352RANSIZ3:POP HL 3353 RET 3358SETRAN: LD HL,(PARAMS) 3359 LD DE,32 3360 CALL COMPRAND 3361 LD HL,33 3362 ADD HL,DE3363 LD (HL),C 3364 INC HL3365 LD (HL),B 3366 INC HL3367 LD (HL),A 3368 RET 33693374LOGINDRV: LD HL,(LOGIN) 3375 LD A,(ACTIVE) 3376 LD C,A3377 CALL SHIFTR 3378 PUSH HL 3379 EX DE,HL3380 CALL SELECT 3381 POP HL3382 CALL Z,SLCTERR 3383 LD A,L 3384 RRA 3385 RET C3386 LD HL,(LOGIN) 3387 LD C,L3388 LD B,H3389 CALL SETBIT3390 LD (LOGIN),HL 3391 JP BITMAP 3395SETDSK: LD A,(EPARAM) 3396 LD HL,ACTIVE 3397 CP (HL)3398 RET Z3399 LD (HL),A 3400 JP LOGINDRV34013406AUTOSEL:LD A,0FFH 3407 LD (AUTO),A3408 LD HL,(PARAMS) 3409 LD A,(HL)3410 AND 1FH 3411 DEC A 3412 LD (EPARAM),A 3413 CP 1EH 3414 JP NC,AUTOSL1 3415 LD A,(ACTIVE) 3416 LD (OLDDRV),A 3417 LD A,(HL) 3418 LD (AUTOFLAG),A 3419 AND 0E0H 3420 LD (HL),A 3421 CALL SETDSK 3422AUTOSL1:LD A,(USERNO) 3423 LD HL,(PARAMS) 3424 OR (HL)3425 LD (HL),A3426 RET 3430GETVER: LD A,022H 3431 JP SETSTAT34323435RSTDSK: LD HL,0 3436 LD (WRTPRT),HL 3437 LD (LOGIN),HL3438 XOR A 3439 LD (ACTIVE),A3440 LD HL,TBUFF 3441 LD (USERDMA),HL3442 CALL DEFDMA3443 JP LOGINDRV 3447OPENFIL:CALL CLEARS2 3448 CALL AUTOSEL 3449 JP OPENIT 3453CLOSEFIL: CALL AUTOSEL 3454 JP CLOSEIT 3460GETFST: LD C,0 3461 EX DE,HL3462 LD A,(HL) 3463 CP '?'3464 JP Z,GETFST1 3465 CALL SETEXT 3466 LD A,(HL) 3467 CP '?' 3468 CALL NZ,CLEARS2 3469 CALL AUTOSEL 3470 LD C,15 3471GETFST1:CALL FINDFST 3472 JP MOVEDIR 3476GETNXT: LD HL,(SAVEFCB) 3477 LD (PARAMS),HL 3478 CALL AUTOSEL 3479 CALL FINDNXT 3480 JP MOVEDIR34813484DELFILE:CALL AUTOSEL 3485 CALL ERAFILE 3486 JP STSTATUS 3491READSEQ:CALL AUTOSEL 3492 JP RDSEQ34933496WRTSEQ: CALL AUTOSEL 3497 JP WTSEQ34983501FCREATE:CALL CLEARS2 3502 CALL AUTOSEL 3503 JP GETEMPTY 3507RENFILE:CALL AUTOSEL 3508 CALL CHGNAMES 3509 JP STSTATUS35103513GETLOG: LD HL,(LOGIN)3514 JP GETPRM135153518GETCRNT:LD A,(ACTIVE)3519 JP SETSTAT35203523PUTDMA: EX DE,HL3524 LD (USERDMA),HL 3525 JP DEFDMA 3529GETALOC:LD HL,(ALOCVECT)3530 JP GETPRM135313534GETROV: LD HL,(WRTPRT)3535 JP GETPRM135363539SETATTR:CALL AUTOSEL 3540 CALL SAVEATTR3541 JP STSTATUS35423546GETPARM:LD HL,(DISKPB)3547GETPRM1:LD (STATUS),HL3548 RET 35493554GETUSER:LD A,(EPARAM) 3555 CP 0FFH 3556 JP NZ,SETUSER3557 LD A,(USERNO) 3558 JP SETSTAT3559SETUSER:AND 1FH 3560 LD (USERNO),A 3561 RET 35623565RDRANDOM: CALL AUTOSEL 3566 JP READRAN35673570WTRANDOM: CALL AUTOSEL 3571 JP WRITERAN35723575FILESIZE: CALL AUTOSEL 3576 JP RANSIZE35773584LOGOFF: LD HL,(PARAMS) 3585 LD A,L 3586 CPL 3587 LD E,A 3588 LD A,H3589 CPL 3590 LD HL,(LOGIN) 3591 AND H3592 LD D,A3593 LD A,L3594 AND E3595 LD E,A3596 LD HL,(WRTPRT)3597 EX DE,HL3598 LD (LOGIN),HL 3599 LD A,L 3600 AND E3601 LD L,A3602 LD A,H3603 AND D3604 LD H,A3605 LD (WRTPRT),HL 3606 RET 36073610GOBACK: LD A,(AUTO) 3611 OR A3612 JP Z,GOBACK13613 LD HL,(PARAMS) 3614 LD (HL),0 3615 LD A,(AUTOFLAG)3616 OR A3617 JP Z,GOBACK13618 LD (HL),A 3619 LD A,(OLDDRV) 3620 LD (EPARAM),A3621 CALL SETDSK3622GOBACK1:LD HL,(USRSTACK) 3623 LD SP,HL3624 LD HL,(STATUS) 3625 LD A,L 3626 LD B,H3627 RET 3636WTSPECL:CALL AUTOSEL 3637 LD A,2 3638 LD (MODE),A3639 LD C,0 3640 CALL POSITN1 3641 CALL Z,WTSEQ1 3642 RET 36433650EMPTYFCB: DEFB 0E5H 3651WRTPRT: DEFW 0 3652LOGIN: DEFW 0 3653USERDMA:DEFW 080H 3657SCRATCH1: DEFW 0 3658SCRATCH2: DEFW 0 3659SCRATCH3: DEFW 0 3663DIRBUF: DEFW 0 3664DISKPB: DEFW 0 3665CHKVECT:DEFW 0 3666ALOCVECT: DEFW 0 3670SECTORS:DEFW 0 3671BLKSHFT:DEFB 0 3672BLKMASK:DEFB 0 3673EXTMASK:DEFB 0 3674DSKSIZE:DEFW 0 3675DIRSIZE:DEFW 0 3676ALLOC0: DEFW 0 3677ALLOC1: DEFW 03678OFFSET: DEFW 0 3679XLATE: DEFW 0 3682CLOSEFLG: DEFB 0 3683RDWRTFLG: DEFB 0 3684FNDSTAT:DEFB 0 3685MODE: DEFB 0 3686EPARAM: DEFB 0 3687RELBLOCK: DEFB 0 3688COUNTER:DEFB 0 3689SAVEFCB:DEFW 0,0 3690BIGDISK:DEFB 0 3691AUTO: DEFB 0 3692OLDDRV: DEFB 0 3693AUTOFLAG: DEFB 0 3694SAVNXT: DEFB 0 3695SAVEXT: DEFB 0 3696SAVNREC:DEFW 0 3697BLKNMBR:DEFW 0 3698LOGSECT:DEFW 0 3699FCBPOS: DEFB 0 3700FILEPOS:DEFW 0 3705CKSUMTBL: DEFB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,037063709 DEFB 0,0,0,037103717BOOT: JP 0 3718WBOOT: JP 03719CONST: JP 03720CONIN: JP 03721CONOUT: JP 03722LIST: JP 03723PUNCH: JP 03724READER: JP 03725HOME: JP 03726SELDSK: JP 03727SETTRK: JP 03728SETSEC: JP 03729SETDMA: JP 03730READ: JP 03731WRITE: JP 03732PRSTAT: JP 03733SECTRN: JP 037343739